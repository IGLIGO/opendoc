# ComiNode-GW

本文档内容描述了与蓝牙Mesh网关模块`ComiNode-GW`通信的协议格式。

## 序

协议框架如下：

![](./table_temp.png)

## 指令列表

指令列表头部的十六进制数表示指令的`索引`。

### 通知

在监测到某些事件发生时，模块会将事件通知通过接口进行上报。

- `0x01`|设备入网(通知)
  - 当自动扫描搜索到新的设备，并成功添加入网后产生此通知
- `0x02`|~~设备上线(通知)~~
  - ~~当设备由离线状态变更为在线状态时产生此通知~~
- `0x03`|~~设备离线(通知)~~
  - ~~当设备由在线状态变更为离线状态时产生此通知~~
- `0x04`|~~设备退网(通知)~~
  - ~~当设备成功退网时，产生此通知~~
- `0x05`|收到消息(通知)
  - 收到订阅地址或者点对点消息
- `0x06`|收到心跳包(通知)
  - 收到心跳包
- `0x80`|配网状态变更

### 控制

- `0xAA`|测试接口
- `0x80`|限时配网模式
  - 进入配网模式，连续1分钟未配网设备则超时退出
- `0x81`|~~枚举网络设备~~
  - ~~枚举网络中已注册的所有设备地址(unicast addr)~~
- `0x82`|获取设备信息
  - 获取指定地址(unicast addr)设备的信息
- `0x83`|冻结模式(停止自动扫描添加新设备)
- `0x84`|解除冻结(恢复自动扫描添加新设备)
- `0x85`|设置设备订阅地址
  - 设置设备接收消息的地址(独立地址或组地址)
- `0x86`|设置设备上报地址
  - 设置设备上报消息的地址(独立地址或组地址)
- `0x87`|唯一地址通信(unicast addr)
  - 指定unicast地址发送消息
- `0x88`|订阅地址通信(subscribe addr)
  - 指定订阅地址发送消息
- `0x89`|移除设备
  - 从网络中移除指定设备
  - 注意，如果没有冻结自动配网，则可能被移除的设备会很快被自动重新加入网络
- `0x8A`|移除所有设备并重启
  - 重置网关

## 指令内容

为简化描述，下述对指令内容的描述均只针对协议载荷部分，重复的前缀与后缀内容请参考页面顶端的框架描述。

下表为协议载荷的结构：

| Bytes | 内容     | 备注                                                     |
| ----- | -------- | -------------------------------------------------------- |
| 0     | CUID0    | 16位循环唯一ID                                           |
| 1     | CUID1    | 通知消息会循环增加。返回和错误消息会与请求时的CUID一致。 |
| 2     | 类型     | 0x00:通知<br>0x01:控制<br>0xAA:返回<br>0xFF:错误         |
| 3     | 索引     |                                                          |
| 4~n   | 指令内容 |                                                          |

接下来将逐条描述每个协议索引的指令内容的结构。

由于每条协议都包括同样的如下结构，非载荷部分将在描述中省略。

~~`固定前缀`-`随机数`-`异或值1`-`载荷长度`-`异或值2`~~-**`载荷`**-~~`校验和`~~



> [!NOTE]
>
> 载荷只包含`CUID`与`0xAA`类型的数据包为`ACK`包。表示对于对应`CUID`数据包的确认。



#### 测试指令

用于测试串口通信是否正常。通常，测试IO将与一个LED连接，可以通过LED的亮灭直接观察到通信结果。

| 备注     | 内容                                             |
| -------- | ------------------------------------------------ |
| 类型     | 0x01                                             |
| 索引     | 0xAA                                             |
| 指令内容 | 0x55, 0x01(测试IO置高)<br>0x55, 0x00(测试IO置低) |



#### 设备入网

| 备注     | 内容                    |
| -------- | ----------------------- |
| 类型     | 0x00                    |
| 索引     | 0x01                    |
| 指令内容 | unicast address(2bytes) |



#### 配网状态变更

| 备注     | 内容                                                      |
| -------- | --------------------------------------------------------- |
| 类型     | 0x00                                                      |
| 索引     | 0x80                                                      |
| 指令内容 | 0x00:冻结模式<br>0x01:限时配网模式<br>0x03:不限时配网模式 |



#### 收到消息

| 备注     | 内容                                                         |
| -------- | ------------------------------------------------------------ |
| 类型     | 0x00                                                         |
| 索引     | 0x05                                                         |
| 指令内容 | 来源(0x00:点对点消息; 0x01:订阅地址消息) <br>来源地址(2bytes) <br>消息内容(0-8bytes) |



#### 收到心跳包

| 备注     | 内容                                                |
| -------- | --------------------------------------------------- |
| 类型     | 0x00                                                |
| 索引     | 0x06                                                |
| 指令内容 | 来源地址(2 bytes) <br>RSSI (1 byte [signed 8 bit] ) |



#### 获取设备信息

| 备注     | 内容                                        |
| -------- | ------------------------------------------- |
| 类型     | 0x01                                        |
| 索引     | 0x82                                        |
| 指令内容 | 设备地址(2bytes)<br>信息类型(0x00:设备类型) |

返回如下：

| 备注     | 内容     |
| -------- | -------- |
| 类型     | 0xAA     |
| 索引     | 0x82     |
| 指令内容 | 设备类型 |



#### 限时配网模式

> 如果设备处于不限时配网模式或冻结模式，则进入限时配网模式。如果设备处于配网模式，则重置超时时间。

| 备注     | 内容       |
| -------- | ---------- |
| 类型     | 0x01       |
| 索引     | 0x80       |
| 指令内容 | `Reserved` |

返回`配网状态变更`通知



#### 冻结模式

> 无论设备处于何种配网模式，都将切换到冻结模式

| 备注     | 内容       |
| -------- | ---------- |
| 类型     | 0x01       |
| 索引     | 0x83       |
| 指令内容 | `Reserved` |

返回`配网状态变更`通知



#### 解除冻结

> 无论设备处于何种配网模式，都将切换到不限时配网模式

| 备注     | 内容       |
| -------- | ---------- |
| 类型     | 0x01       |
| 索引     | 0x84       |
| 指令内容 | `Reserved` |

返回`配网状态变更`通知



#### 设置设备订阅地址

| 备注     | 内容                                 |
| -------- | ------------------------------------ |
| 类型     | 0x01                                 |
| 索引     | 0x85                                 |
| 指令内容 | 设备地址(2bytes)<br>订阅地址(2bytes) |

返回为`ACK`



#### 设置设备上报地址

| 备注     | 内容                                 |
| -------- | ------------------------------------ |
| 类型     | 0x01                                 |
| 索引     | 0x86                                 |
| 指令内容 | 设备地址(2bytes)<br>上报地址(2bytes) |

返回为`ACK`



#### 唯一地址通信

| 备注     | 内容                                  |
| -------- | ------------------------------------- |
| 类型     | 0x01                                  |
| 索引     | 0x87                                  |
| 指令内容 | unicast地址(2bytes)<br>内容(0-8bytes) |

返回为`ACK`



#### 订阅地址通信

| 备注     | 内容                               |
| -------- | ---------------------------------- |
| 类型     | 0x01                               |
| 索引     | 0x88                               |
| 指令内容 | 订阅地址(2bytes)<br>内容(0-8bytes) |

返回为`ACK`



#### 移除设备

| 备注     | 内容                |
| -------- | ------------------- |
| 类型     | 0x01                |
| 索引     | 0x89                |
| 指令内容 | unicast地址(2bytes) |

返回为`ACK`



#### 移除所有设备

| 备注     | 内容       |
| -------- | ---------- |
| 类型     | 0x01       |
| 索引     | 0x8A       |
| 指令内容 | `reserved` |

返回为`ACK`

